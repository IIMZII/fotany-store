<!DOCTYPE html>
<html lang="en" dir="ltr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Fotany Store</title>
  <meta name="description" content="Fotany Store — Buy and sell online usernames/handles." />
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <style>
    .fade-in { animation: fade-in .2s ease-out; }
    @keyframes fade-in { from {opacity:0; transform:translateY(4px)} to {opacity:1; transform:none} }
    .staff-only[disabled], .staff-only.hidden { display: none !important; }
  </style>
</head>
<body class="bg-zinc-50 text-zinc-900">
  <!-- Header -->
  <header class="sticky top-0 z-40 bg-white/80 backdrop-blur border-b border-zinc-200">
    <div class="max-w-6xl mx-auto px-4 py-3 flex items-center gap-3">
      <div class="h-9 w-9 rounded-xl bg-zinc-900 text-white grid place-content-center font-bold">F</div>
      <div class="flex-1">
        <h1 class="text-xl font-semibold leading-tight">Fotany Store</h1>
        <p class="text-xs text-zinc-500">Official marketplace by Fotany. Buy and sell exclusive usernames.</p>
      </div>
      <div class="flex items-center gap-2">
        <button id="loginBtn" class="text-sm px-3 py-2 rounded-xl border border-zinc-300 hover:bg-zinc-100">Login</button>
        <a href="#add" id="addListingBtn" class="hidden sm:inline-block text-sm px-3 py-2 rounded-xl border border-zinc-300 hover:bg-zinc-100">Add listing</a>
      </div>
    </div>
  </header>

  <!-- Hero -->
  <section class="border-b border-zinc-200 bg-white/40">
    <div class="max-w-6xl mx-auto px-4 py-10 md:py-14 grid md:grid-cols-2 gap-6 items-center">
      <div>
        <h2 class="text-2xl md:text-3xl font-bold">Welcome to Fotany Store</h2>
        <p class="mt-2 text-zinc-600">Shop clean, rare, and brandable usernames. Public catalog. Staff-only edits.</p>
        <div class="mt-5 flex flex-wrap items-center gap-3">
          <a id="browseBtn" href="#catalogSection" class="px-4 py-2 rounded-xl bg-zinc-900 text-white hover:bg-zinc-800">Browse the store</a>
          <a href="https://www.tiktok.com/@fotany" target="_blank" class="px-4 py-2 rounded-xl border border-zinc-300 hover:bg-zinc-100">TikTok: @fotany</a>
        </div>
      </div>

      <div class="bg-white rounded-2xl border border-zinc-200 p-4 shadow-sm">
        <h3 class="font-semibold">Store account</h3>
        <p class="text-sm text-zinc-600 mt-1">Use <b>Discord</b> or <b>Telegram</b> for questions. Listings are synced for everyone.</p>
        <div class="mt-4 grid gap-2 text-sm">
          <div class="flex items-center justify-between">
            <span class="text-zinc-600">TikTok</span>
            <a class="text-zinc-900 underline" href="https://www.tiktok.com/@fotany" target="_blank">@fotany</a>
          </div>
          <div class="flex items-center justify-between">
            <span class="text-zinc-600">Discord</span>
            <span class="text-zinc-900">Server invite below</span>
          </div>
        </div>
      </div>
    </div>
  </section>

  <!-- Filters -->
  <section id="catalogSection" class="scroll-mt-24 max-w-6xl mx-auto px-4 py-4">
    <div class="grid grid-cols-1 md:grid-cols-5 gap-3">
      <div class="md:col-span-2">
        <label class="text-xs text-zinc-600">Search</label>
        <input id="search" type="text" placeholder="Search usernames, tags..." class="w-full mt-1 px-3 py-2 rounded-xl border border-zinc-300 focus:outline-none focus:ring-2 focus:ring-zinc-400" />
      </div>
      <div>
        <label class="text-xs text-zinc-600">Platform</label>
        <select id="platform" class="w-full mt-1 px-3 py-2 rounded-xl border border-zinc-300 bg-white">
          <option value="">All</option>
          <option>Instagram</option><option>TikTok</option><option>X</option><option>Snapchat</option><option>Discord</option><option>Gaming</option><option>Email</option><option>Other</option>
        </select>
      </div>
      <div>
        <label class="text-xs text-zinc-600">Status</label>
        <select id="status" class="w-full mt-1 px-3 py-2 rounded-xl border border-zinc-300 bg-white">
          <option value="">All</option>
          <option value="Available">Available</option><option value="Reserved">Reserved</option><option>Sold</option>
        </select>
      </div>
      <div>
        <label class="text-xs text-zinc-600">Sort</label>
        <select id="sort" class="w-full mt-1 px-3 py-2 rounded-xl border border-zinc-300 bg-white">
          <option value="new">Newest</option>
          <option value="priceAsc">Price: Low → High</option>
          <option value="priceDesc">Price: High → Low</option>
          <option value="name">A → Z</option>
        </select>
      </div>
    </div>
  </section>

  <!-- Catalog -->
  <main class="max-w-6xl mx-auto px-4 pb-20">
    <div id="catalog" class="grid sm:grid-cols-2 lg:grid-cols-3 gap-4"></div>
    <div id="emptyState" class="hidden text-center py-16 text-zinc-500">No results. Try clearing filters.</div>
  </main>

  <!-- Footer -->
  <footer class="border-t border-zinc-200 bg-white/70 backdrop-blur">
    <div class="max-w-6xl mx-auto px-4 py-6 text-sm text-zinc-600 flex flex-col sm:flex-row items-center justify-between gap-2">
      <div>© <span id="year"></span> Fotany Store. All rights reserved.</div>
      <div class="flex items-center gap-3">
        <a href="https://www.tiktok.com/@fotany" target="_blank" class="px-3 py-1.5 rounded-lg border border-zinc-300 hover:bg-zinc-100">TikTok: @fotany</a>
        <span class="px-3 py-1.5 rounded-lg border border-zinc-300 bg-zinc-100">Discord: join below</span>
      </div>
    </div>
  </footer>

  <!-- Login Modal -->
  <div id="loginModal" class="hidden fixed inset-0 z-50" aria-modal="true" role="dialog">
    <div class="absolute inset-0 bg-black/40" onclick="closeLogin()" aria-hidden="true"></div>
    <div class="relative max-w-sm mx-auto mt-32 bg-white rounded-2xl shadow-xl p-5 fade-in">
      <div class="flex items-start justify-between gap-4">
        <h3 class="text-lg font-semibold">Login</h3>
        <button class="text-zinc-500 hover:text-zinc-900" onclick="closeLogin()" aria-label="Close">✕</button>
      </div>
      <form id="loginForm" class="mt-3 grid gap-3">
        <div>
          <label class="text-xs text-zinc-600">Username or Email</label>
          <input name="email" type="text" required class="w-full mt-1 px-3 py-2 rounded-xl border border-zinc-300" placeholder="mohamed or you@domain.com" />
        </div>
        <div>
          <label class="text-xs text-zinc-600">Password</label>
          <input name="pass" type="password" required class="w-full mt-1 px-3 py-2 rounded-xl border border-zinc-300" placeholder="••••••" />
        </div>
        <button class="px-4 py-2 rounded-xl bg-zinc-900 text-white hover:bg-zinc-800">Login</button>
        <p class="text-xs text-zinc-500">Local login works now (mohamed / Mm322610@123). For shared edits, connect Supabase below.</p>
      </form>
    </div>
  </div>

  <!-- Admin Dashboard -->
  <div id="adminModal" class="hidden fixed inset-0 z-50" aria-modal="true" role="dialog">
    <div class="absolute inset-0 bg-black/40" onclick="closeAdmin()" aria-hidden="true"></div>
    <div class="relative max-w-4xl mx-auto mt-12 bg-white rounded-2xl shadow-xl p-5 fade-in">
      <div class="flex items-start justify-between gap-4">
        <h3 class="text-lg font-semibold">Dashboard</h3>
        <button class="text-zinc-500 hover:text-zinc-900" onclick="closeAdmin()" aria-label="Close">✕</button>
      </div>

      <div class="mt-4 flex gap-2">
        <button class="tab-btn px-3 py-2 rounded-xl border border-zinc-300" id="tabListings" aria-selected="true">Listings</button>
      </div>

      <div id="panelListings" class="mt-4">
        <form id="addForm" class="grid sm:grid-cols-2 gap-3">
          <div>
            <label class="text-xs text-zinc-600">Username</label>
            <input name="username" required class="w-full mt-1 px-3 py-2 rounded-xl border border-zinc-300" placeholder="@DesertKing" />
          </div>
          <div>
            <label class="text-xs text-zinc-600">Platform</label>
            <select name="platform" class="w-full mt-1 px-3 py-2 rounded-xl border border-zinc-300">
              <option>Instagram</option><option>TikTok</option><option>X</option><option>Snapchat</option><option>Discord</option><option>Gaming</option><option>Email</option><option>Other</option>
            </select>
          </div>
          <div>
            <label class="text-xs text-zinc-600">Price (number)</label>
            <input name="price" type="number" step="1" min="0" required class="w-full mt-1 px-3 py-2 rounded-xl border border-zinc-300" placeholder="1500" />
          </div>
          <div>
            <label class="text-xs text-zinc-600">Tags (comma-separated)</label>
            <input name="tags" class="w-full mt-1 px-3 py-2 rounded-xl border border-zinc-300" placeholder="arabic, luxury, short" />
          </div>
          <div>
            <label class="text-xs text-zinc-600">Status</label>
            <select name="status" class="w-full mt-1 px-3 py-2 rounded-xl border border-zinc-300">
              <option>Available</option><option>Reserved</option><option>Sold</option>
            </select>
          </div>
          <div class="sm:col-span-2 flex items-center justify-end gap-2 mt-2">
            <button type="button" id="refreshBtn" class="px-3 py-2 rounded-xl border border-zinc-300 hover:bg-zinc-100">Refresh</button>
            <button class="px-4 py-2 rounded-xl bg-zinc-900 text-white hover:bg-zinc-800">Add listing</button>
          </div>
        </form>
        <div class="mt-4">
          <h4 class="text-sm font-medium mb-2">Current Listings</h4>
          <div id="adminList" class="text-sm divide-y divide-zinc-200"></div>
        </div>
      </div>
    </div>
  </div>

  <script>
  // ======== CONFIG ========
  const SUPABASE_URL = 'https://YOUR-PROJECT.supabase.co'; // put real project URL
  const SUPABASE_ANON_KEY = 'YOUR-ANON-KEY';               // put real anon key
  const CURRENCY = 'AED';
  const PUBLIC_READ = true; // everyone can open dashboard to view (read-only if not staff)

  // ======== SUPABASE / MODE ========
  const sb = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY, { auth: { persistSession: true } });
  const supaConfigured = !SUPABASE_URL.includes('YOUR-PROJECT') && !SUPABASE_ANON_KEY.includes('YOUR-ANON-KEY');
  const MODE = supaConfigured ? 'supabase' : 'local';

  // ======== LOCAL DB (fallback) ========
  const LSK = { db: 'fs:db' };
  function uuid(){ return (crypto&&crypto.randomUUID)?crypto.randomUUID():Math.random().toString(16).slice(2)+'-'+Date.now(); }
  function lget(){ try{ return JSON.parse(localStorage.getItem(LSK.db)||'{}'); } catch { return {}; } }
  function lset(v){ localStorage.setItem(LSK.db, JSON.stringify(v)); }
  function ensureSeed(){ const db=lget(); db.listings??=[
      { id:'seed1', username:'@DesertKing', platform:'Instagram', price:3500, tags:['arabic','luxury'], status:'Available', created_at:'2025-08-20T09:00:00Z' },
      { id:'seed2', username:'@FalconTech', platform:'X',         price:2800, tags:['tech','uae'],    status:'Available', created_at:'2025-08-18T13:00:00Z' },
      { id:'seed3', username:'@Mawsem',     platform:'Instagram', price:4200, tags:['honey'],         status:'Reserved',  created_at:'2025-08-17T10:30:00Z' }
    ]; lset(db); }
  if (MODE==='local') ensureSeed();

  // ======== API (listings only) ========
  const api = MODE==='supabase' ? {
    async list(){ const { data, error } = await sb.from('listings').select('*').order('created_at', {ascending:false}); if(error) throw error; return data||[]; },
    async add(it){
      const { data: user } = await sb.auth.getUser();
      if (!user?.user) throw new Error('Not logged in');
      const { error } = await sb.from('listings').insert({ username:it.username, platform:it.platform, price:it.price, tags:it.tags, status:it.status });
      if (error) throw error;
    },
    async del(id){
      const { data: user } = await sb.auth.getUser();
      if (!user?.user) throw new Error('Not logged in');
      const { error } = await sb.from('listings').delete().eq('id', id);
      if (error) throw error;
    },
    async login(email, password){
      const { data, error } = await sb.auth.signInWithPassword({ email, password });
      if (error) throw error;
      // check profiles.is_staff
      const { data: prof, error: pErr } = await sb.from('profiles').select('is_staff').eq('id', data.user.id).single();
      if (pErr || !prof?.is_staff) throw new Error('Not staff');
      return true;
    }
  } : {
    async list(){ return lget().listings || []; },
    async add(it){ const db=lget(); it.id=uuid(); it.created_at=new Date().toISOString(); db.listings=[it,...(db.listings||[])]; lset(db); },
    async del(id){ const db=lget(); db.listings=(db.listings||[]).filter(x=>String(x.id)!==String(id)); lset(db); },
    async login(u,p){ return (u.toLowerCase()==='mohamed'||u.toLowerCase()==='mohamed@local.dev') && p==='Mm322610@123'; }
  };

  // ======== UI/State ========
  const els = Object.fromEntries(['year','catalog','emptyState','search','platform','status','sort','browseBtn','loginBtn','addListingBtn','loginModal','loginForm','adminModal','addForm','adminList','refreshBtn','tabListings','panelListings'].map(id=>[id,document.getElementById(id)]));
  let isStaff = false, cache = [];

  const money = (n) => new Intl.NumberFormat(undefined,{style:'currency',currency:'USD'}).format(n).replace('US$ ', CURRENCY+' ');
  const platformColor = (p) => ({ Instagram:'bg-pink-600', TikTok:'bg-gray-900', X:'bg-black', Snapchat:'bg-yellow-400 text-black', Discord:'bg-indigo-600', Gaming:'bg-emerald-600', Email:'bg-zinc-700', Other:'bg-zinc-500' }[p]||'bg-zinc-500');

  function openLogin(){ els.loginModal.classList.remove('hidden'); }
  function closeLogin(){ els.loginModal.classList.add('hidden'); }
  function openAdmin(){
    if (!isStaff && !PUBLIC_READ) { openLogin(); return; }
    els.adminModal.classList.remove('hidden');
    const addBtn = els.addForm.querySelector('button[type="submit"]');
    if (!isStaff) { // public view only
      addBtn.classList.add('staff-only'); addBtn.setAttribute('disabled','true');
      els.adminList.classList.remove('pointer-events-auto'); // no effect, but keep
    } else {
      addBtn.classList.remove('staff-only'); addBtn.removeAttribute('disabled');
    }
    refreshAdminList();
  }
  function closeAdmin(){ els.adminModal.classList.add('hidden'); }

  async function render(){
    try { cache = await api.list(); } catch { cache = []; }
    const q=(els.search.value||'').toLowerCase().trim(), pf=els.platform.value||'', st=els.status.value||'', sort=els.sort.value||'new';
    let list = cache.filter(it=>{
      const MQ = !q || (it.username||'').toLowerCase().includes(q) || (Array.isArray(it.tags)?it.tags.join(' '):String(it.tags||'')).toLowerCase().includes(q);
      const MP = !pf || it.platform===pf, MS = !st || it.status===st; return MQ && MP && MS;
    });
    list.sort((a,b)=> sort==='priceAsc'? a.price-b.price : sort==='priceDesc'? b.price-a.price : sort==='name'? String(a.username).localeCompare(String(b.username)) : new Date(b.created_at||0)-new Date(a.created_at||0));
    const wrap = els.catalog; wrap.innerHTML = '';
    if (!list.length){ els.emptyState.classList.remove('hidden'); return; } else { els.emptyState.classList.add('hidden'); }
    list.forEach(it=>{
      const sold=it.status==='Sold', reserved=it.status==='Reserved';
      const statusClass=sold?'bg-zinc-200 text-zinc-700': reserved?'bg-amber-100 text-amber-800':'bg-emerald-100 text-emerald-800';
      const tagBadges=(Array.isArray(it.tags)?it.tags: String(it.tags||'').split(',')).filter(Boolean).slice(0,5).map(t=>`<span class="px-2 py-0.5 rounded-lg text-xs border border-zinc-300 bg-white">${t}</span>`).join(' ');
      const card=document.createElement('div'); card.className='bg-white rounded-2xl border border-zinc-200 p-4 shadow-sm hover:shadow-md transition-shadow fade-in flex flex-col justify-between';
      card.innerHTML=`
        <div class="flex items-start justify-between gap-3">
          <div>
            <div class="text-lg font-semibold break-all">${it.username}</div>
            <div class="mt-1 flex items-center gap-2"><span class="px-2 py-1 rounded-lg text-xs text-white ${platformColor(it.platform)}">${it.platform}</span> ${tagBadges}</div>
          </div>
          <div class="text-right">
            <div class="text-base font-semibold">${money(Number(it.price||0))}</div>
            <div class="mt-1 inline-flex items-center px-2 py-0.5 rounded-lg text-xs ${statusClass}">${it.status||'Available'}</div>
          </div>
        </div>`;
      wrap.appendChild(card);
    });
  }

  async function refreshAdminList(){
    const data = await api.list();
    els.adminList.innerHTML = (data||[]).map(x=>`
      <div class="py-2 flex items-center justify-between gap-3">
        <div class="truncate">
          <span class="font-medium">${x.username}</span>
          <span class="text-zinc-500">• ${x.platform}</span>
          <span class="ml-2 text-zinc-400 text-xs">${money(Number(x.price||0))} — ${x.status||'Available'}</span>
        </div>
        <div class="flex items-center gap-2">
          <button class="px-2 py-1 rounded-lg border border-zinc-300 hover:bg-zinc-100 text-xs ${!isStaff?'staff-only':''}" data-action="del" data-id="${x.id}" ${!isStaff?'disabled':''}>Delete</button>
        </div>
      </div>`).join('') || '<div class="py-3 text-zinc-500">No listings yet.</div>';
  }

  // ======== EVENTS ========
  document.getElementById('year').textContent = new Date().getFullYear();
  ['search','platform','status','sort'].forEach(k=> els[k].addEventListener('input', render));
  els.browseBtn.addEventListener('click', e=>{ e.preventDefault(); document.getElementById('catalogSection').scrollIntoView({behavior:'smooth'}); });

  // Open dashboard (public read is allowed)
  els.addListingBtn.addEventListener('click', e=>{ e.preventDefault(); openAdmin(); });

  // Login
  document.getElementById('loginForm').addEventListener('submit', async (e)=>{
    e.preventDefault();
    const fd=new FormData(e.target); const u=String(fd.get('email')||'').trim(); const p=String(fd.get('pass')||'');
    try{
      if (MODE==='supabase'){
        await api.login(u, p);
      } else {
        const ok = await api.login(u, p);
        if (!ok) throw new Error('Invalid');
      }
      isStaff = true; closeLogin(); openAdmin();
    } catch(err){ alert('Invalid credentials'); }
  });
  els.loginBtn.addEventListener('click', openLogin);

  // Add listing (staff only)
  els.addForm.addEventListener('submit', async (e)=>{
    e.preventDefault();
    if (!isStaff){ alert('Read-only for public'); return; }
    const fd=new FormData(els.addForm);
    const item={ username:String(fd.get('username')||'').trim(), platform:fd.get('platform'), price:Number(fd.get('price')||0), tags:String(fd.get('tags')||'').split(',').map(s=>s.trim()).filter(Boolean), status:fd.get('status') };
    try { await api.add(item); els.addForm.reset(); await refreshAdminList(); await render(); } catch { alert('Add failed (check auth / policies)'); }
  });

  // Delete listing (staff only)
  document.getElementById('adminList').addEventListener('click', async (e)=>{
    const btn=e.target.closest('button[data-action="del"]'); if(!btn) return;
    if (!isStaff){ alert('Read-only for public'); return; }
    const id=btn.getAttribute('data-id'); if(!confirm('Delete this listing?')) return;
    try { await api.del(id); await refreshAdminList(); await render(); } catch { alert('Delete failed (check auth / policies)'); }
  });

  // Start
  render();
  </script>

  <section class="max-w-6xl mx-auto px-4 py-6 text-xs text-zinc-500">
    <p><strong>Heads-up:</strong> Selling/transferring social handles may violate platform Terms. You’re responsible for compliance and safe transfers.</p>
  </section>
</body>
</html>
